---
title: 兼容模式 PRD
description: Fumadocs 兼容模式功能需求文档
---

# Fumadocs 兼容模式 PRD

## 1. 概述

兼容模式（Compat Mode）是一个让 Fumadocs 能够渲染非标准 markdown 文件的引擎层。它解决了以下问题：

- 原始 markdown 文件没有 fumadocs 需要的 frontmatter（title, description）
- 文件格式不是 MDX，包含 MDX 解析器不兼容的语法
- 需要快速预览/发布现有的 markdown 文档集合

## 2. 核心功能需求

### 2.1 自动元数据提取

| 字段 | 提取规则 | 回退方案 |
| --- | --- | --- |
| title | 第一个 `#` 标题 | 文件名（去除扩展名，转换格式） |
| description | 第一段非标题文本（前 200 字符） | "No description available" |

### 2.2 文件优先级排序

1. **README.md** - 如果存在，始终作为第一个文档（index 页面）
2. **index.md / index.mdx** - 目录索引文件
3. **其他文件** - 按字母顺序排列

### 2.3 MDX 兼容性预处理

需要处理的边缘情况：

| 情况 | 示例 | 处理方式 |
| --- | --- | --- |
| 小于号后跟数字 | `<16Ω` | 转义为 `&lt;16Ω` |
| 花括号 | `{variable}` | 转义为 `\{variable\}` |
| JSX-like 语法 | `<Component />` | 保持不变（有效 JSX） |
| 表格中的特殊字符 | 见上 | 在表格行中激进转义 |
| 代码块内容 | 任意内容 | 不做处理（代码块自动保护） |
| 内联代码 | `` `code` `` | 保护内联代码内容 |

### 2.4 目录结构映射

```
pm-notes/                    →  /raw-notes/
├── README.md               →  /raw-notes (index)
├── getting-started.md      →  /raw-notes/getting-started
├── guides/
│   ├── index.md           →  /raw-notes/guides
│   └── advanced.md        →  /raw-notes/guides/advanced
```

## 3. 边缘情况处理

### 3.1 空目录

- 如果目录为空或只有不支持的文件，显示友好的空状态页面
- 不应该报错或 404

### 3.2 文件编码

- 默认 UTF-8
- 检测 BOM 并正确处理
- 非 UTF-8 文件应记录警告但不中断

### 3.3 超大文件

- 文件大小限制：10MB
- 超过限制时显示警告，截断内容

### 3.4 循环链接

- 检测 markdown 中的相对链接
- 自动转换内部链接到正确的 URL 路径

### 3.5 图片路径

- 相对路径图片：尝试从同目录加载
- 绝对路径图片：保持不变
- 外部 URL：保持不变

### 3.6 特殊文件名

| 文件名 | 处理 |
| --- | --- |
| `.hidden.md` | 忽略（以点开头） |
| `_draft.md` | 忽略（以下划线开头） |
| `file name.md` | 转换为 `file-name` |
| `中文文件.md` | 转换为 URL 安全的 slug |

## 4. 配置选项

```typescript
interface CompatSourceOptions {
  // 必需
  dir: string;           // 内容目录路径
  baseUrl: string;       // URL 基础路径

  // 可选
  extensions?: string[]; // 支持的扩展名，默认 ['.md', '.mdx']
  indexFiles?: string[]; // 索引文件名，默认 ['README.md', 'index.md']
  ignore?: string[];     // 忽略的文件模式
  
  // 自定义提取器
  titleExtractor?: (content: string, filePath: string) => string;
  descriptionExtractor?: (content: string, filePath: string) => string;
}
```

## 5. 导航行为

### 5.1 默认首页

- 访问 `/raw-notes` 时：
  1. 优先显示 README.md 内容
  2. 如果没有 README.md，重定向到第一个可用文档
  3. 如果没有任何文档，显示空状态

### 5.2 侧边栏

- 自动构建页面树
- README.md 显示为"概述"或"Overview"
- 支持嵌套文件夹

## 6. 实现状态

- [x] 基础兼容层引擎
- [x] 自动标题/描述提取
- [x] MDX 预处理（基础字符转义）
- [ ] README.md 作为 index
- [ ] 空状态处理
- [ ] 相对链接转换
- [ ] 图片路径处理
- [ ] 配置选项完善

